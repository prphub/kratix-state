#!/usr/bin/env bash

set -e

echo "Setting up ServiceNow credentials for testing..."

# Check if credentials exist
if kubectl --context="${PLATFORM}" get secret servicenow-credentials --namespace kratix-platform-system >/dev/null 2>&1; then
    echo "ServiceNow credentials already exist"
    exit 0
fi

# Prompt for ServiceNow details
read -p "Enter ServiceNow instance (without .service-now.com): " INSTANCE
read -p "Enter ServiceNow username: " USERNAME
read -s -p "Enter ServiceNow password: " PASSWORD
echo

# Create secret
kubectl --context="${PLATFORM}" create secret generic servicenow-credentials \
    --namespace kratix-platform-system \
    --from-literal=instance="${INSTANCE}" \
    --from-literal=username="${USERNAME}" \
    --from-literal=password="${PASSWORD}"

echo "✅ ServiceNow credentials created successfully"

# Test connection
echo "Testing ServiceNow connection..."
RESPONSE=$(curl -s -u "${USERNAME}:${PASSWORD}" \
    "https://${INSTANCE}.service-now.com/api/now/table/u_kratix_ticket?sysparm_limit=1")

if echo "${RESPONSE}" | jq -e '.result' >/dev/null 2>&1; then
    echo "✅ ServiceNow connection test successful"
else
    echo "❌ ServiceNow connection test failed"
    echo "Response: ${RESPONSE}"
    exit 1
fi
